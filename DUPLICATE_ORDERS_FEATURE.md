# 重複訂單檢測功能說明

## 📋 功能概述

重複訂單檢測功能能夠自動識別系統中具有相同電話號碼的訂單，幫助管理員快速發現可能的重複下單情況，提升訂單管理效率。

## ✨ 主要特點

### 🔍 智能檢測
- **電話號碼標準化**：自動處理各種電話號碼格式
- **後9碼比對**：使用後9碼邏輯，兼容不同格式的電話號碼
- **即時更新**：訂單新增、修改、刪除時自動重新檢測

### 🎯 視覺警示
- **自動警示**：首次載入時如有重複訂單自動彈窗警示
- **按鈕提示**：首頁顯示「重複訂單(數量)」按鈕
- **電話警示**：重複電話號碼後顯示紅色警告圖示 ⚠️
- **詳細對話框**：點擊按鈕查看完整的重複訂單資訊

### 📊 統計分析
- **群組分類**：按電話號碼分組顯示重複訂單
- **數量統計**：即時顯示重複訂單總數
- **排序顯示**：按重複數量降序排列

## 🏗️ 技術架構

### 前端元件
- **Index.tsx**：主頁面，包含重複訂單按鈕和狀態管理
- **OrderList.tsx**：訂單列表，顯示電話號碼警示圖示
- **DuplicateOrdersDialog.tsx**：重複訂單詳細資訊對話框

### 服務層
- **orderService.ts**：
  - `detectDuplicateOrders()`：檢測重複訂單
  - `isOrderDuplicate()`：檢查單個訂單是否重複
  - `normalizePhone()`：電話號碼標準化

### 資料結構
```typescript
interface DuplicateOrder {
  id: string;
  orderNumber: string;
  customerName: string;
  customerPhone: string;
  normalizedPhone: string;
}

interface DuplicateGroup {
  phone: string;
  normalizedPhone: string;
  orders: DuplicateOrder[];
  count: number;
}
```

## 🚀 使用方式

### 1. 自動警示（首次載入）
系統會在首次載入訂單資料時自動檢測重複訂單：
- 如果發現重複訂單，會自動彈出紅色警示對話框
- 標題顯示「⚠️ 重複訂單警示」
- 提供詳細的重複訂單資訊
- 點擊「我知道了」關閉警示
- 同一瀏覽器會話中只顯示一次

### 2. 查看重複訂單統計
在首頁操作按鈕區域查看「重複訂單(X)」按鈕，X表示重複訂單總數

### 3. 識別重複電話
在訂單列表中，重複電話號碼後會顯示紅色警告圖示 ⚠️

### 4. 手動查看詳細資訊
點擊「重複訂單(X)」按鈕，開啟詳細資訊對話框：
- 標題顯示「重複訂單檢測結果」
- 黃色主題的查詢模式
- 點擊「關閉」結束查看

### 5. 分析重複情況
在對話框中查看：
- 按電話號碼分組的重複訂單
- 每個群組的訂單詳細資訊
- 重複數量統計

## 🔧 電話號碼標準化邏輯

### 支援格式
系統能正確識別以下電話號碼格式：
- `0912345678`（標準格式）
- `912345678`（省略開頭0）
- `09-1234-5678`（含連字號）
- `0912-345-678`（不同連字號位置）
- `+886912345678`（含國碼）

### 比對邏輯
1. **移除特殊符號**：去除所有非數字字符
2. **取後9碼**：使用電話號碼的後9位數字進行比對
3. **群組分類**：相同後9碼的訂單歸為一組

### 範例說明
以下電話號碼會被識別為重複：
- `0912345678` → 後9碼：`912345678`
- `+886912345678` → 後9碼：`912345678`
- `09-1234-5678` → 後9碼：`912345678`

## 📊 功能特點

### 即時更新機制
- **新增訂單**：自動檢測新訂單是否與現有訂單重複
- **修改訂單**：電話號碼變更時重新檢測
- **刪除訂單**：刪除後自動更新重複狀態

### 效能優化
- **記憶體快取**：重複檢測結果暫存在記憶體中
- **增量更新**：只在訂單變更時重新計算
- **分頁友好**：不影響訂單列表的分頁效能

### 用戶體驗
- **主動警示**：首次載入時自動提醒管理員
- **直觀警示**：清楚的視覺提示
- **詳細資訊**：完整的重複訂單資訊
- **操作簡單**：一鍵查看所有重複情況
- **雙重模式**：自動警示和手動查看兩種模式

## 🎯 使用場景

### 1. 日常監控
管理員可以隨時查看系統中的重複訂單情況

### 2. 客戶服務
當客戶詢問訂單狀態時，快速識別是否有重複下單

### 3. 資料清理
定期檢查並處理重複訂單，保持資料品質

### 4. 業務分析
分析重複下單的模式，優化訂單流程

## 🛡️ 注意事項

### 資料準確性
- 電話號碼格式需要相對標準
- 建議定期檢查電話號碼資料品質

### 效能考量
- 大量訂單時檢測可能需要較長時間
- 建議在非高峰時段進行大量資料檢測

### 業務邏輯
- 重複電話不一定代表重複訂單
- 可能是同一客戶的多次正常下單
- 需要人工判斷具體情況

## 🎨 對話框模式差異

### 自動警示模式（首次載入）
- **觸發時機**：系統首次載入訂單資料時
- **視覺主題**：紅色警示主題
- **標題**：「⚠️ 重複訂單警示」
- **描述**：「系統檢測到 X 組重複電話，共 Y 筆訂單，請注意檢查！」
- **按鈕**：「我知道了」（紅色主題）
- **底部提示**：「🚨 建議立即檢查這些重複訂單，確認是否為同一客戶的重複下單或系統錯誤」

### 手動查看模式（點擊按鈕）
- **觸發時機**：用戶主動點擊「重複訂單(X)」按鈕
- **視覺主題**：黃色查詢主題
- **標題**：「重複訂單檢測結果」
- **描述**：「發現 X 組重複電話，共 Y 筆訂單」
- **按鈕**：「關閉」（灰色主題）
- **底部提示**：「💡 提示：點擊訂單可查看詳細資訊，建議檢查是否為同一客戶的重複下單」

### 共同特點
- 內容區域完全相同
- 都顯示按電話號碼分組的重複訂單
- 都支援點擊訂單查看詳情（如果實作）
- 都提供完整的訂單資訊（編號、姓名、電話）

## 📝 更新記錄

### v1.0.0 (2024-12-19)
- ✅ 新增重複訂單檢測功能
- ✅ 實作電話號碼標準化邏輯
- ✅ 建立重複訂單顯示對話框
- ✅ 新增訂單列表警示圖示
- ✅ 實作即時更新機制

### v1.1.0 (2024-12-19)
- ✅ 新增自動警示功能（首次載入時彈窗）
- ✅ 實作雙重對話框模式（自動警示 vs 手動查看）
- ✅ 優化用戶體驗（不同主題色彩和提示訊息）
- ✅ 新增會話記憶機制（避免重複彈窗）

## 🔮 未來規劃

### 可能的增強功能
- 支援更多比對條件（姓名+電話）
- 重複訂單自動合併建議
- 重複訂單統計報表
- 客戶重複下單行為分析

---

**提示**：此功能主要用於輔助管理員識別可能的重複訂單，具體是否為重複仍需人工判斷。建議結合客戶姓名、地址等資訊進行綜合分析。
