# 批次刪除訂單功能說明

## 📋 功能概述

批次刪除訂單功能允許管理員一次性刪除多筆選中的訂單，提高訂單管理效率。此功能包含完整的安全機制和用戶體驗優化。

## ✨ 主要特點

### 🔒 安全機制
- **二次確認**：顯示詳細的確認對話框，列出將要刪除的訂單資訊
- **明確警告**：清楚告知用戶此操作不可復原
- **防誤操作**：需要明確點擊確認才能執行刪除

### 🎯 用戶體驗
- **直觀操作**：在批次操作區域提供醒目的紅色刪除按鈕
- **即時反饋**：顯示載入狀態和處理進度
- **詳細結果**：明確告知成功/失敗的訂單數量和詳情
- **自動更新**：刪除完成後自動重新整理訂單列表

### 🔧 技術特點
- **批次處理**：支援同時刪除多筆訂單
- **錯誤處理**：部分失敗時明確告知哪些訂單刪除失敗
- **資料同步**：同步更新 Google Sheets 並清除快取
- **ID 重排序**：自動重新排序後續訂單的 ID 保持連續性（N欄）
- **資料完整性**：確保刪除後所有ID與行索引保持一致

## 🏗️ 技術架構

### 前端元件
- **OrderList.tsx**：主要訂單列表元件，包含批次刪除按鈕
- **BatchDeleteConfirmDialog.tsx**：批次刪除確認對話框元件

### 後端 API
- **batch_delete_orders.php**：批次刪除訂單的 API 端點
- **reorderOrderIdsAfterBatchDelete()**：ID 重新排序函數
- **delete_order.php**：單個刪除訂單（也包含ID重新排序）

### 服務層
- **orderService.ts**：`batchDeleteOrders()` 函數處理前端 API 呼叫

## 🔄 ID 重新排序機制

### 工作原理
當訂單被刪除後，系統會自動重新排序所有後續訂單的ID，確保ID的連續性：

1. **刪除訂單**：從 Google Sheets 中真正刪除訂單行
2. **重新讀取**：獲取刪除後的最新資料
3. **重新分配ID**：將N欄的ID重新設定為對應的行索引
4. **批次更新**：使用 Google Sheets API 批次更新所有ID

### 範例說明
假設有5筆訂單（ID: 1,2,3,4,5），刪除ID為2和4的訂單後：
- **刪除前**：ID 1,2,3,4,5 對應行 2,3,4,5,6
- **刪除後**：ID 1,2,3 對應行 2,3,4（原本的1,3,5）
- **重新排序**：確保ID與行索引一致

### 驗證方法
使用提供的測試腳本驗證ID重新排序：
```bash
php test_batch_delete_id_reorder.php
```

## 🚀 使用方式

### 1. 選擇訂單
在訂單列表中勾選一個或多個要刪除的訂單

### 2. 點擊批次刪除
在批次操作區域點擊「批次刪除 (X)」按鈕

### 3. 確認刪除
在確認對話框中檢視要刪除的訂單詳情，點擊「確認刪除」

### 4. 完成操作
系統會顯示處理結果，並自動更新訂單列表

## 📊 API 規格

### 請求格式
```json
{
  "ids": ["1", "2", "3"],
  "timestamp": 1234567890,
  "nonce": "abc123"
}
```

### 回應格式
```json
{
  "success": true,
  "message": "批次刪除完成：成功 3 筆，失敗 0 筆",
  "results": [
    {
      "id": "1",
      "success": true,
      "message": "刪除成功",
      "orderNumber": "A001"
    }
  ],
  "totalDeleted": 3,
  "totalFailed": 0,
  "reorder_result": {
    "success": true,
    "updated_rows": 5
  }
}
```

## 🛡️ 安全考量

### 資料保護
- 永久刪除前提供詳細確認資訊
- 無法復原的操作有明確警告
- 防止意外觸發的多重確認機制

### 權限控制
- 僅管理員可執行批次刪除操作
- API 端點包含適當的權限驗證

### 資料一致性
- 使用事務性操作確保資料完整性
- 失敗時提供詳細的錯誤資訊
- 自動清除快取確保資料同步

## 🔧 維護說明

### 日誌記錄
- 所有批次刪除操作都會記錄在系統日誌中
- 包含操作時間、用戶、影響的訂單數量

### 監控指標
- 批次刪除操作的成功率
- 平均處理時間
- 錯誤類型統計

### 備份建議
- 定期備份 Google Sheets 資料
- 重要操作前建議手動備份

## 📝 更新記錄

### v1.0.0 (2024-12-19)
- ✅ 新增批次刪除訂單功能
- ✅ 實作確認對話框元件
- ✅ 建立批次刪除 API 端點
- ✅ 新增 ID 重新排序機制
- ✅ 完善錯誤處理和用戶體驗

---

**注意**：此功能涉及永久刪除資料，使用時請謹慎操作，建議在重要操作前先備份資料。
